<!--index.wxml
 * @author ZU_xian
 * @copyright ZU_xian UDP file transfer WeChat applet
 * Created by ZU_xian (2025)
 * All rights reserved.
-->
<view class="container">
  <view class="connection-status" wx:if="{{connectedUser}}">
    <view class="status-content">
      <text class="disconnect-btn" bindtap="handleDisconnect">å–æ¶ˆè¿æ¥</text>
    </view>
  </view>

  <view class="transfer-info-panel" wx:if="{{connectedUser}}">
    <view class="transfer-info-container">
      <view class="file-info-section" wx:if="{{selectedFile || currentReceivedFile}}">
        <view class="file-info-header">
          <text class="file-info-title">æ–‡ä»¶ä¿¡æ¯</text>
          <text class="file-status-tag {{transferStatus}}">
            {{transferStatus === 'transferring' ? 'ä¼ è¾“ä¸­' : 
            transferStatus === 'completed' ? 'å·²å®Œæˆ' : 
            transferStatus === 'preparing' ? 'å‡†å¤‡ä¸­' :
            transferStatus === 'error' ? 'ä¼ è¾“å¤±è´¥' : 
            transferStatus === 'interrupted' ? 'å·²ä¸­æ–­' : 'ç­‰å¾…ä¸­'}}
          </text>
        </view>
        
        <view class="file-details">
          <text class="file-name">{{(selectedFile && selectedFile.name) || (currentReceivedFile && currentReceivedFile.name) || 'æ— æ–‡ä»¶å'}}</text>
          <text class="file-size">{{(selectedFile && formatFileSize(selectedFile.size)) || (currentReceivedFile && formatFileSize(currentReceivedFile.size)) || '0 B'}}</text>
        </view>
        
        <view class="transfer-progress-container" wx:if="{{transferProgress > 0}}">
          <progress 
            class="transfer-progress-bar" 
            percent="{{transferProgress}}" 
            stroke-width="4" 
            activeColor="#e77c8e" 
            backgroundColor="#f5f5f5"
          />
          <view class="transfer-stats">
            <text class="transfer-percentage">{{transferProgress}}%</text>
            <text class="transfer-speed" wx:if="{{transferSpeed}}">{{transferSpeed}}</text>
          </view>
        </view>
      </view>
      
      <view class="save-location-section" wx:if="{{currentReceivedFile}}">
        <view class="location-header">
          <text class="location-title">ä¿å­˜ä½ç½®</text>
          <text class="copy-path" data-path="{{currentReceivedFile.path}}" bindtap="copyFilePath">å¤åˆ¶è·¯å¾„</text>
        </view>
        <text class="location-path">{{currentReceivedFile.path}}</text>
      </view>
      
      <view class="recent-files-section" wx:if="{{receivedFiles.length > 0}}">
        <view class="recent-header">
          <text class="recent-title">æœ€è¿‘æ¥æ”¶çš„æ–‡ä»¶</text>
          <text class="clear-history" bindtap="clearReceivedHistory">æ¸…ç©º</text>
        </view>
        <scroll-view scroll-y class="recent-files-list">
          <view 
            class="recent-file-item" 
            wx:for="{{receivedFiles}}" 
            wx:key="path"
            bindtap="handleFileItemTap"
            data-file-path="{{item.path}}"
          >
            <view class="file-icon">ğŸ“„</view>
            <view class="recent-file-info">
              <text class="recent-file-name">{{item.name}}</text>
              <text class="recent-file-meta">{{formatFileSize(item.size)}} Â· {{formatTimestamp(item.timestamp)}}</text>
            </view>
          </view>
        </scroll-view>
      </view>
      
      <view class="no-transfer-state" wx:if="{{!selectedFile && !currentReceivedFile && receivedFiles.length === 0}}">
        <text class="no-transfer-text">å·²è¿æ¥ï¼Œè¯·ç‚¹å‡» + é€‰æ‹©æ–‡ä»¶å‘é€ï¼Œæˆ–ç­‰å¾…æ¥æ”¶æ–‡ä»¶</text>
      </view>
    </view>
  </view>

  <view class="upload-container {{isSearching ? 'hidden' : ''}}">
    <view class="upload-button" bindtap="handleUpload">
      <text class="plus-icon">+</text>
    </view>
  </view>

  <view class="device-list {{isSearching ? 'show' : ''}} {{isEnhancedMode ? 'enhanced' : ''}}">
    <view class="device-list-header">
      <view class="header-content">
        <text wx:if="{{nearbyUsers.length > 0}}">å‘ç° {{nearbyUsers.length}} ä¸ªè®¾å¤‡</text>
      </view>
      <view class="header-right">
        <text class="transfer-mode-text" wx:if="{{isSearching}}">
          <text class="status-label">ç›®å‰çŠ¶æ€</text>
          {{transferMode === 'both' ? 'WiFi + è“ç‰™' : 
          transferMode === 'bluetooth' ? 'è“ç‰™' : 
          transferMode === 'wifi' ? 'WiFi' : 
          'æ— ä¿¡å·'}}
        </text>
        <view class="enhance-mode-container {{isSearching ? 'show' : ''}}" wx:if="{{isSearching}}">
          <button 
            class="enhance-mode-btn {{isEnhancedMode ? 'active' : ''}}" 
            catchtap="toggleEnhancedMode"
          >
            ä¿¡å·å¢å¼º {{isEnhancedMode ? 'å·²å¼€å¯' : ''}}
          </button>
        </view>
      </view>
    </view>
    
    <view 
      class="device-item {{item.isEnhanced ? 'enhanced' : ''}}" 
      wx:for="{{isSearching ? nearbyUsers : []}}" 
      wx:key="deviceId"
      bindtap="handleConnect"
      data-deviceid="{{item.deviceId}}"
      style="pointer-events: {{connectedUser && (item.deviceId === connectedUser.deviceId || connectedUser) ? 'none' : 'auto'}}"
    >
      <view class="device-info">
        <view class="device-name-container">
          <text class="device-name">{{item.name || 'æœªçŸ¥è®¾å¤‡'}}</text>
          <text class="device-type-tag {{item.via === 'bluetooth' ? 'bluetooth' : 'wifi'}}">
            {{item.via === 'bluetooth' ? 'è“ç‰™' : 'WiFi'}}
          </text>
        </view>
        <text class="device-signal">ä¿¡å·å¼ºåº¦: {{item.RSSI}}dBm</text>
        <text class="enhanced-tag" wx:if="{{item.isEnhanced}}">å¢å¼ºå‘ç°</text>
      </view>
      <view class="device-status">
        <text class="status-text {{connectedUser && item.deviceId === connectedUser.deviceId ? 'connected' : ''}}">
          {{connectedUser && item.deviceId === connectedUser.deviceId ? 'å·²è¿æ¥' : 
            connectedUser ? 'è®¾å¤‡å·²è¢«å ç”¨' : 'ç‚¹å‡»è¿æ¥'}}
        </text>
      </view>
    </view>
    
    <view class="empty-state" wx:if="{{isSearching && nearbyUsers.length === 0}}">
      <text>è¯·ç¡®ä¿å¦ä¸€å°è®¾å¤‡åŒæ ·è¿›å…¥æ­¤å°ç¨‹åº</text>
    </view>
  </view>

  <view class="pair-code-modal" wx:if="{{showPairCodeInput}}">
    <view class="pair-code-content">
      <text class="pair-code-title">è®¾å¤‡é…å¯¹</text>
      <text class="pair-code-subtitle">è¯·è¾“å…¥å¯¹æ–¹è®¾å¤‡æ˜¾ç¤ºçš„4ä½é…å¯¹ç å®Œæˆè¿æ¥</text>
      <input 
        class="pair-code-input" 
        type="number" 
        placeholder="4ä½é…å¯¹ç "
        maxlength="4"
        value="{{pairCode}}"
        bindinput="onPairCodeInput"
        focus="{{true}}"
      />
      <view class="pair-code-buttons">
        <button class="cancel-btn" bindtap="cancelOngoingPairing">å–æ¶ˆ</button>
      </view>
    </view>
  </view>

  <view class="transfer-progress" wx:if="{{transferProgress > 0}}">
    <progress percent="{{transferProgress}}" stroke-width="3" activeColor="#e77c8e"/>
    <text class="progress-text">ä¼ è¾“è¿›åº¦: {{transferProgress}}%</text>
  </view>

  <view class="bottom-buttons">
    <button 
      class="action-btn search {{isSearching ? 'searching' : ''}}" 
      bindtap="handleSearchNearby"
    >
      {{isSearching ? 'åœæ­¢æœç´¢' : 'æœç´¢é™„è¿‘çš„äºº'}}
    </button>
    <button 
      class="action-btn send"
      bindtap="handleUpload"
      disabled="{{!connectedUser}}"
    >
      å‘é€
    </button>
  </view>
</view>

<view class="search-loading {{isSearching ? 'show' : ''}}">
  <view class="loading-circle"></view>
</view>

<view class="pairing-status" wx:if="{{false}}">
  <view class="pairing-content">
    <view class="pairing-spinner"></view>
    <text class="pairing-text">{{pairingStatus}}</text>
  </view>
</view>
